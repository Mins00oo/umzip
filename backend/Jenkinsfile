pipeline {
    agent any

    environment {
        REPO_URL = 'https://github.com/Mins00oo/umzip.git'
        BACKEND_DIR = 'backend'
        DOCKER_IMAGE = 'be-app' // Docker 이미지 이름
        CONTAINER_NAME = 'backend-application' // Docker 컨테이너 이름
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([$class: 'GitSCM',
                          branches: [[name: 'main']],
                          userRemoteConfigs: [[url: 'https://github.com/Mins00oo/umzip.git', credentialsId: 'accesstoken_username']]
                ])
            }

            steps {
                // backend 폴더로 이동
                dir("${BACKEND_DIR}") {
                    // Checkout 완료 후 backend 폴더로 이동
                    echo "Moved to ${BACKEND_DIR} directory"
                }
            }
        }

        stage('Tests') {
            steps {
                dir("${BACKEND_DIR}") {
                    sh 'chmod +x ./gradlew'
                    sh './gradlew test'
                }
            }
        }

        stage('Build') {
            steps {
                dir("${BACKEND_DIR}") {
                    withCredentials([file(credentialsId: 'APPLICATION_ENV_YML', variable: 'APP_ENV_FILE')]) {
                        sh './gradlew build'
                        sh 'cp $APP_ENV_FILE ./application-env.yml'
                    }
                }
            }
        }

        stage('Stop and Remove Existing Docker Container') {
            steps {
                // 기존 도커 컨테이너 중지 및 삭제
                script {
                    // 이미 실행 중인 컨테이너를 중지
                    sh """
                    if [ \$(docker ps -q -f name=${CONTAINER_NAME}) ]; then
                        echo "Stopping running container: ${CONTAINER_NAME}"
                        docker stop ${CONTAINER_NAME}
                    fi
                    """
                    // 컨테이너 삭제
                    sh """
                    if [ \$(docker ps -a -q -f name=${CONTAINER_NAME}) ]; then
                        echo "Removing container: ${CONTAINER_NAME}"
                        docker rm ${CONTAINER_NAME}
                    fi
                    """
                    // 기존 도커 이미지를 삭제
                    sh """
                    if [ \$(docker images -q ${DOCKER_IMAGE}) ]; then
                        echo "Removing image: ${DOCKER_IMAGE}"
                        docker rmi -f ${DOCKER_IMAGE}
                    fi
                    """
                }
            }
        }

        stage('Run Docker Container') {
            steps {
                dir("${BACKEND_DIR}") {
                    sh """
                    echo "Building new Docker image: ${DOCKER_IMAGE}"
                    docker build -t ${DOCKER_IMAGE} .

                    echo "Running new Docker container: ${CONTAINER_NAME}"
                    docker run -d --name ${CONTAINER_NAME} -p 8080:8080 ${DOCKER_IMAGE}
                    """
                }
            }
        }
    }

    post {
        always {
            // 빌드 완료 후 결과 출력
            echo 'Pipeline has finished'
        }
        failure {
            // 빌드 실패 시 알림 (필요시 Slack 알림 등을 추가할 수 있음)
            echo 'Build failed'
        }
    }
}
